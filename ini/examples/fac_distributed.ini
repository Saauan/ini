process main() {
	@init() {
		fac(9)
	}
}

process fac(n) {
	@init() {
		i = 1
		println("coucou fac "+i+","+n)
		produce("fac_request_"+n, n)
	}
	i <= n {
		p(copy(i++))
	}
	@consume[channel="fac_result_"+n](f) {
		println("final fac_result: "+n)
		result = f
		println("hourra: "+f)
	}	
}

process p(n) {
	@init() {
		println("started p("+n+")")
	}
	@consume[channel = "fac_request_"+n](n) {
		println("fac_request: "+n)
		case {
			n == 1 {
				produce("fac_result_"+1, 1)
			}
			n > 1 {
				produce("fac_request_"+(n-1), n-1)
			}
		}
	}
	@consume[channel="fac_result_"+(n-1)](f) {
		println("fac_result: "+(n-1)+" -> "+f)
		produce("fac_result_"+n, f * n)
	}
	@end() {
		print("done")
	}
}
