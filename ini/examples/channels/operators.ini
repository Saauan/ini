
import "ini/lib/chanop.ini"

declare channel origin(Int)
declare channel a(Int)
declare channel b(Int)
declare channel c(Int)
declare channel d(Int)
declare channel e(Int)

process producer() {
	@init() {
		tick = 0
	}
	e = @every() : [time = 200] {
		origin.produce(tick)
		tick++
	}
	tick >= 10 {
		e.stop()
		sleep(120) // let some time because of the delay
		origin.stop()
		return
	}
}

origin.duplicate(a, b)
e.merge(a, d.delay(100, c.map(b, x => 2 * x))).consume(x => println("e: "+x))
producer()

//forked = origin.duplicate()
//forked[0].merge(forked[1].delay(500).map(x => 2 * x)).consume(x => println("e: "+x))

