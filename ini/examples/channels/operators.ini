
import "ini/lib/chanop.ini"

declare channel origin(Int)
declare channel a(Int)
declare channel b(Int)
declare channel c(Int)
declare channel d(Int)
declare channel e(Int)

process producer() {
	@init() {
		tick = 0
	}
	e = @every() : [time = 1000] {
		origin.produce(tick)
		tick++
	}
	tick >= 10 {
		e.stop()
		sleep(600) // let some time because of the delay
		origin.stop()
		return
	}
}

origin.fork(a, b)
e.merge(a, d.delay(500, c.map(b, x => 2 * x))).consume(x => println("e: "+x))
producer()