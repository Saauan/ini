process main() {
	@init() {
		fac(3)
	}
}

process fac(n) {
	@init() {
		i = 1
		println("coucou fac "+i+","+n)
		produce("fac_request_"+n, n)
	}
	i <= n {
		p(copy(i++)) [node="n"+i]
	}	
	@consume(f) [channel="fac_result_"+n] {
		println("final fac_result: "+n)
		result = f
		println("hourra: "+f)
	}	
}

process p(n) {
	@init() {
		println("started p("+n+")")
	}
	@consume(n) [channel = "fac_request_"+n] {
		println("fac_request: "+n)
		case {
			n == 1 {
				println("n==1")
				produce("fac_result_"+1, 1)
			}
			n > 1 {
				println("n>1")
				produce("fac_request_"+(n-1), n-1)
			}
		}
	}
	@consume(f) [channel="fac_result_"+(n-1)] {
		println("fac_result: "+(n-1)+" -> "+f)
		produce("fac_result_"+n, f * n)
	}
	@end() {
		print("done")
	}
}
